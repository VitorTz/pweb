<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lines of Action</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">    
    <link rel="stylesheet" href="styles/style.css">
</head>
<body>
    <main>
        <h1>Lines of Action</h1>        
        <div class="game-area">
            <div class="game-container">
                <div id="players" class="panel">
                    <div>Player 1 (⚫): <span id="p1Score">12</span></div>
                    <div>Player 2 (⚪): <span id="p2Score">12</span></div>
                </div>
                <div id="board"></div>
                <div id="status">Vez do Jogador 1 (⚫)</div>
                <button id="reset" class="button" onclick="initBoard()">Reiniciar</button>
            </div>

            <div class="info-container panel">
                <h3>Histórico de Jogadas</h3>
                <div id="history"></div>
            </div>
        </div>
    </main>

    <script>
        const size = 8;
        let board = [];
        let currentPlayer = 'B';
        let selected = null;
        let history = [];

        // Cores do tabuleiro agora são definidas no CSS, mas mantemos as variáveis para referência no JS se necessário
        const boardColor1 = getComputedStyle(document.documentElement).getPropertyValue('--board-color-1');
        const boardColor2 = getComputedStyle(document.documentElement).getPropertyValue('--board-color-2');


        function initBoard() {
            const boardDiv = document.getElementById("board");
            boardDiv.innerHTML = "";
            board = [];
            history = [];
            selected = null;
            currentPlayer = 'B';
            document.getElementById("history").innerHTML = "";
            document.getElementById("p1Score").innerText = 12;
            document.getElementById("p2Score").innerText = 12;
            document.getElementById("status").innerText = "Vez do Jogador 1 (⚫)";

            for (let r = 0; r < size; r++) {
                board[r] = [];
                for (let c = 0; c < size; c++) {
                    const cell = document.createElement("div");
                    cell.classList.add("cell");
                    cell.dataset.row = r;
                    cell.dataset.col = c;

                    // As cores do tabuleiro agora são definidas via CSS, mas podemos aplicar aqui também por segurança
                    cell.style.backgroundColor = (r + c) % 2 === 0 ? boardColor1 : boardColor2;

                    cell.addEventListener("click", () => handleClick(r, c));
                    boardDiv.appendChild(cell);
                    board[r][c] = "";
                }
            }

            for (let i = 1; i < size - 1; i++) {
                board[0][i] = "B";
                board[7][i] = "B";
                board[i][0] = "W";
                board[i][7] = "W";
            }

            renderBoard();
        }

        function renderBoard() {
            document.querySelectorAll(".cell").forEach(cell => {
                const r = cell.dataset.row;
                const c = cell.dataset.col;
                cell.innerHTML = "";
                cell.classList.remove("highlight", "selected-piece-cell");
                if (board[r][c] !== "") {
                    const piece = document.createElement("div");
                    piece.classList.add("piece");
                    // Adiciona a classe da cor em vez de um estilo inline
                    piece.classList.add(board[r][c] === "B" ? 'black-piece' : 'white-piece');
                    cell.appendChild(piece);
                }
            });
            // Re-aplica o destaque na peça selecionada
            if (selected) {
                const selectedCell = document.querySelector(`.cell[data-row='${selected.row}'][data-col='${selected.col}']`);
                if (selectedCell) {
                    selectedCell.classList.add("selected-piece-cell");
                }
            }
        }

        function handleClick(r, c) {
            document.querySelectorAll(".cell").forEach(cell => cell.classList.remove("highlight", "selected-piece-cell"));

            if (selected) {
                const valid = getValidMoves(selected.row, selected.col);
                if (valid.some(m => m.r === r && m.c === c)) {
                    makeMove(selected.row, selected.col, r, c);
                    selected = null;
                    renderBoard();
                } else if (board[r][c] === currentPlayer) {
                    selected = { row: r, col: c };
                    highlightValidMoves(r, c);
                } else {
                    selected = null;
                    renderBoard();
                }
            } else if (board[r][c] === currentPlayer) {
                selected = { row: r, col: c };
                highlightValidMoves(r,c);
            }
        }
        
        function highlightValidMoves(r, c) {
             renderBoard();
             const selectedCell = document.querySelector(`.cell[data-row='${r}'][data-col='${c}']`);
             if(selectedCell) selectedCell.classList.add("selected-piece-cell");

             const valid = getValidMoves(r, c);
             valid.forEach(m => {
                 const cell = document.querySelector(`.cell[data-row='${m.r}'][data-col='${m.c}']`);
                 if(cell) cell.classList.add("highlight");
             });
        }

        function getValidMoves(r, c) {
            const directions = [
                [1, 0], [-1, 0], [0, 1], [0, -1],
                [1, 1], [1, -1], [-1, 1], [-1, -1]
            ];
            const moves = [];
            const player = board[r][c];

            for (const [dr, dc] of directions) {
                let count = 0;
                // Conta peças na linha HORIZONTAL
                if(dr !== 0 && dc === 0) {
                    for(let i=0; i < size; i++) if(board[r][i] !== "") count++;
                }
                // Conta peças na linha VERTICAL
                else if(dr === 0 && dc !== 0) {
                    for(let i=0; i < size; i++) if(board[i][c] !== "") count++;
                }
                // Conta peças na DIAGONAL (/)
                else if(dr * dc < 0) {
                    for(let i = -size; i < size; i++) {
                       if(r+i >= 0 && r+i < size && c-i >= 0 && c-i < size) {
                           if(board[r+i][c-i] !== "") count++;
                       }
                    }
                }
                // Conta peças na DIAGONAL (\)
                else if(dr * dc > 0) {
                    for(let i = -size; i < size; i++) {
                       if(r+i >= 0 && r+i < size && c+i >= 0 && c+i < size) {
                           if(board[r+i][c+i] !== "") count++;
                       }
                    }
                }
                
                const destR = r + dr * count;
                const destC = c + dc * count;

                if (destR >= 0 && destR < size && destC >= 0 && destC < size) {
                    const targetPiece = board[destR][destC];
                    let isBlocked = false;
                    let stepR = r + dr, stepC = c + dc;
                    while(stepR !== destR || stepC !== destC) {
                        if(board[stepR][stepC] !== "" && board[stepR][stepC] !== player) {
                            isBlocked = true;
                            break;
                        }
                        stepR += dr;
                        stepC += dc;
                    }

                    if (!isBlocked && (targetPiece === "" || targetPiece !== player)) {
                        moves.push({ r: destR, c: destC });
                    }
                }
            }
            return moves;
        }

        function makeMove(r1, c1, r2, c2) {
            const captured = board[r2][c2] !== "";
            if (captured) {
                if (board[r2][c2] === "B") {
                    document.getElementById("p1Score").innerText = parseInt(document.getElementById("p1Score").innerText) - 1;
                } else {
                    document.getElementById("p2Score").innerText = parseInt(document.getElementById("p2Score").innerText) - 1;
                }
            }
            board[r2][c2] = board[r1][c1];
            board[r1][c1] = "";

            history.push(`${currentPlayer === 'B' ? '⚫' : '⚪'}: Move de (${r1},${c1}) para (${r2},${c2})`);
            const historyDiv = document.getElementById("history");
            historyDiv.innerHTML = history.join("<br>");
            historyDiv.scrollTop = historyDiv.scrollHeight;

            currentPlayer = currentPlayer === "B" ? "W" : "B";
            document.getElementById("status").innerText = currentPlayer === "B" ? "Vez do Jogador 1 (⚫)" : "Vez do Jogador 2 (⚪)";
        }

        initBoard();
    </script>
</body>
</html>